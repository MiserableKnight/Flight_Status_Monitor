# 调度模式使用指南

## 快速开始

### 1. 运行测试（验证系统）
```bash
python test_scheduler.py
```
**预期结果**: 所有测试通过 ✅

### 2. 运行交互式模拟（查看运行过程）
```bash
python simulate_scheduler.py
```
**操作**: 按 Enter 键逐步查看一整天的调度运行过程

### 3. 运行真实调度模式
```bash
run_system.bat
```
选择选项 `1` - 调度模式

## 系统运行截图示例

### 启动时显示
```
============================================================
🛫 航班数据抓取系统
============================================================
启动时间: 2026-01-09 06:30:00
============================================================
📋 今日航班计划:
============================================================
  VJ105: 计划起飞 07:45 (北京时间)
           航程 110分钟, 航线 HAN-VCS
  VJ107: 计划起飞 09:15 (北京时间)
           航程 110分钟, 航线 HAN-VCS
  ...
```

### 运行过程中显示
```
============================================================
🔍 [07:45:23] 检查航班状态...
============================================================
🔄 切换到 Leg 数据页面监控
📊 监控 Leg 数据（航段状态）...
✅ Leg数据检查完成

============================================================
📊 航班状态跟踪摘要
============================================================
✈️ B-652G - VJ105
   当前阶段: 空中
   起飞时间: 08:00
   计划到达: 09:50
============================================================
```

## 监控逻辑说明

### 页面切换规则

| 场景 | 条件 | 监控页面 |
|------|------|----------|
| 1️⃣ 起飞前 | 飞机在地面 + 已过计划起飞时间 | 📊 Leg页面 |
| 2️⃣ 空中 | 所有飞机在空中（都有OFF，无IN） | 🔧 故障页面 |
| 3️⃣ 快落地 | 在空中 + 已到计划到达时间 | 📊 Leg页面 |
| 4️⃣ 落地后 | 飞机在地面（有ON无IN） | 📊 Leg页面 |

### 典型时间线（VJ105为例）

```
07:45 ✅ 计划起飞时间 → 监控 Leg页面
07:50 ✅ 滑出 (OUT) → 继续监控 Leg页面
08:00 ✅ 起飞 (OFF) → 切换到 故障页面
08:00-09:40 🔄 在空中 → 监控 故障页面
09:40 ✅ 计划到达时间 → 切回 Leg页面
09:45 ✅ 落地 (ON) → 继续监控 Leg页面
09:50 ✅ 滑入 (IN) → 航班完成
```

## 时间说明

### 内部时间（北京时间）
- 配置文件：`config/flight_schedule.py`
- 数据存储：`data/leg_data.csv`
- 调度判断：所有时间比较

### 展示时间（越南时间）
- 邮件通知：自动转换（北京时间-1小时）
- 用户看到：越南本地时间

### 转换规则
```
越南时间 06:45 → 北京时间 07:45
越南时间 = 北京时间 - 1小时
```

## 故障排查

### 如果系统一直监控 Leg 页面
**原因**: 可能所有飞机都未到计划起飞时间
**解决**: 等待第一班飞机的计划起飞时间

### 如果系统一直监控故障页面
**原因**: 所有飞机都在空中
**解决**: 等待飞机到计划到达时间，会自动切回Leg页面

### 如果没有收到邮件通知
**检查**:
1. `email_config.yaml` 配置是否正确
2. 网络连接是否正常
3. SMTP 服务是否可用

## 配置修改

### 修改航班时间
编辑 `config/flight_schedule.py`:
```python
'VJ105': {
    'scheduled_departure': '07:45',  # 北京时间 (越南时间+1)
    ...
}
```

### 修改运行时间
编辑 `config/config.ini`:
```ini
[scheduler]
start_time = 06:30  # 系统启动时间
end_time = 21:00    # 系统停止时间
```

## 性能指标

- **检查频率**: 每1分钟检查一次航班状态
- **页面切换**: 根据航班状态自动切换
- **资源占用**: 低（大部分时间只监控一个页面）
- **通知及时性**: 状态变化后1分钟内发送邮件

## 技术架构

```
main_scheduler.py (调度器)
    ↓
FlightTracker (状态跟踪)
    ↓
判断: should_monitor_leg_first()
    ↓
┌─────────────┬─────────────┐
│             │             │
Leg页面      故障页面     Flight页面
(leg_fetcher) (faults_fetcher) (flight_fetcher)
```
